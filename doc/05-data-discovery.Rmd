---
title: "Data Discovery "
subtitle: "res431"
author: "pbrunier@cogne.com"
version: 1.0 
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    css: ./custom.css
    df_print: paged
    gallery: no
    highlight: default
    html_document: null
    lightbox: yes
    number_sections: yes
    self_contained: yes
    thumbnails: no
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE,
                      fig.height = 7,
                      fig.width = 10,
                      collapse = TRUE,
                      cols.print=20)
rm(list = ls(all.names = TRUE))
require(dplyr)
require(rlang)
require(kableExtra)
require(readr)
require(ggplot2)
require(reticulate)
require(rpart)
require(rpart.plot)
require(tidyr)
require(randomForest)
source('~/dev/res431/R/function.R')
```

# Analisi per odp

leggiamo i dati 

```{r zerty}
res431 <- read_rds('/data/res431/res431.rds')
                       
```

# Kv contro tutti (odp)

analisi dei trend del tipo x vs y 

```{r correlazioni,results='asis'}
response <- 'kv_valori'
vars <- res431 %>% 
  select(temp_media:rm_valori) %>%
  names()
n <- length(vars)

for (i in seq_len(n)) {
  var_i <- vars[i]
  pl <- ggplot(res431) +
    geom_point(aes(!!sym(var_i),!!sym(response))) +
    geom_smooth(
      aes(!!sym(var_i),!!sym(response)),
      color = 'magenta',
      se = FALSE,
      method = 'loess',
      span=0.75,degree=2
    ) +
    geom_smooth(
      aes(!!sym(var_i),!!sym(response)),
      color = 'blue',
      se = FALSE,
      method = 'lm'
    )
  title <- paste('## Variabile: ', var_i)
  cat(title, '\n')
  print(pl)
  cat('<p>') #necessario per terminare paragrafo
}
```

# Decision Tree (odp)

```{r tree}
dati_tree <- res431 %>% 
  select(temp_media:n_batch_rinv2) 

kv <- res431$kv_valori

dati_tree <- cbind(kv,dati_tree)


fm <- rpart(formula=kv ~ . ,
            data = dati_tree,
            method = 'anova',
            cp = 0.02)

rpart.plot(fm,
           extra=101)

```

<!-- # ```{r random_forest} -->
<!-- # rf <- randomForest(formula = kv_valori ~ . , -->
<!-- #                    data = res431, -->
<!-- #                    ntree = 100) -->
<!-- #  -->
<!-- # # Variable importance plot -->
<!-- # varImpPlot(rf) -->
<!-- #  -->
<!-- #  -->
<!-- # # Plotting model -->
<!-- # plot(rf) -->
<!-- #  -->
<!-- # # Importance plot -->
<!-- # importance(rf) -->
<!-- #  -->
<!-- # ``` -->


# Analisi per triple

leggiamo i dati 

```{r load_dati_tripla}
res431 <- read_rds('/data/res431/res431_grouped.rds')
                       
```

# Kv contro tutti (grouped)

analisi dei trend del tipo x vs y 

```{r correlazioni tripla,results='asis'}
response <- 'kv_valori'
vars <- res431 %>% 
  select(C:n_batch_rinv2) %>%
  names()
n <- length(vars)

for (i in seq_len(n)) {
  var_i <- vars[i]
  pl <- ggplot(res431) +
    geom_point(aes(!!sym(var_i),!!sym(response))) +
    geom_smooth(
      aes(!!sym(var_i),!!sym(response)),
      color = 'magenta',
      se = FALSE,
      method = 'loess',
      span=0.75,degree=2
    ) +
    geom_smooth(
      aes(!!sym(var_i),!!sym(response)),
      color = 'blue',
      se = FALSE,
      method = 'lm'
    )
  title <- paste('## Variabile: ', var_i)
  cat(title, '\n')
  print(pl)
  cat('<p>') #necessario per terminare paragrafo
}
```

# Decision Tree (grouped)

```{r tree tripla}
fm <- rpart(formula=kv_valori ~ .,
            data = res431,
            method = 'anova',
            cp = 0.02)

rpart.plot(fm,
           extra=101)

```